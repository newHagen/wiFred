= Hardware description for wiFreds up to revision 0.5
Heiko Rosemann
include::version_en.adoc[]
:description: Usage documentation, server choices, building instructions, schematics, part lists...
:url-repo: https://github.com/newHeiko/wiFred
:icons: image
:iconsdir: images/icons/
:imagesdir: images/
:toc:

// tag::largefile[]

The wiFred hardware is centered around an ESP8266 for the WiFi connection. The ESP8266 communicates through its serial port with an ATMega 328P microcontroller which manages the power, controls the LEDs, reads the loco selection switches, speed potentiometer, direction switch and pushbutton switches for functions and emergency stop. The communication goes through a 2x3 pin header which enables the user to connect a programming cable to the same serial port if removing the jumpers.

Optionally, two white 5 mm-LEDs protruding from the top of the PCB can be installed to serve as a flashlight. They are driven by a constant-current source directly from the battery and enabled when pushing the yellow SHIFT key.

The wiFred is powered by a single cell LiPo battery (see <<oldThrottle>> for the hardware of earlier prototypes running off AA batteries). The ATMega 328P is connected directly to the LiPo cell, going into sleep mode when no loco selection switch is active, thereby reducing the power consumption to less than 1 µA. The ESP8266 is powered by a low-drop linear voltage regulator with an output voltage of 3 V which is disabled by the ATMega 328P when the device goes into standby.

The schematic is split into several pages and can be found in <<schematic05page1>> to <<schematic05page4>>. It has been created with kicad and is available on the <<github>> along with the PCB design.

[#schematic05page1]
.Master schematic sheet with battery connector, charging circuit and power supply
image::wfred_rev2.png[alt="Schematic sheet 1 for rev0.5]

[#schematic05page2]
.Schematic sheet including ESP8266 for WiFi connection with bootloader enabling jumper and connection to programming cable
image::wfred-wifi-Wifi_connection.png[alt="Schematic sheet 2 for rev0.5]

[#schematic05page3]
.Schematic sheet including ATMega 328P along with crystal and in system programming header
image::wfred-controller_rev2-Controller.png[alt="Schematic sheet 3 for rev0.5]

[#schematic05page4]
.Schematic sheet including pushbutton switches, loco selection switches, direction switch, speed potentiometer and flashlight LEDs with controller
image::User_interface_rev2-User_Interface.png[alt="Schematic sheet 4 for rev0.5]

[#hintsFor05]
== Hints for building revisions up to 0.5

The PCB has holes in the center of the LED footprints to enable transferring their positions to a StrapuBox housing with a sharp needle or to drill pilot holes with a 1 mm drill. For all other holes, there is a drill jig available which also allows the drilling of pilot holes for the pushbutton switches, the direction control switch and the speed potentiometer. <<drilljigPicture>> shows the process and its results. Holes for the pushbutton switches should be drilled at 3.5 mm diameter. Holes for the LEDs should be drilled at 3 mm diameter and holes for the speed potentiometer at 8 mm, for the direction switch at 6.5 mm diameter. The cutouts for the loco selection switches are best drilled at 1.5 mm and extended to fit when the PCB is assembled with a jigsaw or a sharp hobby knife and a file.

[#BOM05]
[cols="1,2,1",options="breakable,autowidth"]
.List of components for the wiFred PCB up to revision 0.5
|===
|Designator|Package|Designation

|C102, C101|C_0805_HandSoldering|4u7

|C105, C103, C302|C_0805_HandSoldering|1u

|C206, C205|C_0805_HandSoldering|22p

|C401, C203, C202, C201, C207|C_0805_HandSoldering|100n

|C402, C301|C_0805_HandSoldering|22u

|C403|C_0805_HandSoldering|100u

|CON101|USB_Micro-B_Molex-105017-0001|USB-MICRO-B

|D101|LED_D3.0mm|LED - red

|D102|LED_D3.0mm|LED - green

|D201|SOT-23_Handsoldering|BAR43

|D301|LED_D3.0mm|STOP - red

|D302|LED_D3.0mm|FORWARD - green

|D303|LED_D3.0mm|REVERSE - green

|D303, D302, D301, D101, D102|LED Spacer|3mm

|D304|LED_D5.0mm_Horicontal_FLIPPED_O1.27mm|LED white

|D305|LED_D5.0mm_Horicontal_O1.27mm|LED white

|IC101|SOT95P270X145-5N|MCP73831T-2ACI_OT

|IC102|SOT95P275X110-5N|NCV8161BSN300T1G

|IC201|TQFP-32_7x7mm_Pitch0.8mm|ATMEGA328P-A

|IC301|SOT-23-6_Handsoldering|MIC2860-2PYD6

|K401|Pin_Header_Straight_1x03_Pitch2.54mm|UART_ESP

|K402|Pin_Header_Straight_1x03_Pitch2.54mm|UART_AVR

|P1|PCB|124mm x 35mm x 1.6mm

|P101|Pin_Header_Angled_1x02_Pitch2.54mm|BATT

|P201|Pin_Header_Straight_2x03_Pitch2.54mm_SMD|ISP

|P401|Pin_Header_Straight_1x02_Pitch2.54mm|ESP_BOOTLOAD

|R101, R102|C_0805_HandSoldering|680R

|R103|C_0805_HandSoldering|2k2

|R301|C_0805_HandSoldering|4k7

|R304, R303, R302, R204|C_0805_HandSoldering|220R

|R305|C_0805_HandSoldering|15k

|R405, R404, R403, R201, R104|C_0805_HandSoldering|10k

|RV301|P160KNPD|10k lin P160KNPD-4FC20B10K

|SW301|OS102011MS2Q|LOCO1

|SW302|OS102011MS2Q|LOCO2

|SW303|OS102011MS2Q|LOCO3

|SW304|OS102011MS2Q|LOCO4

|SW305|SW_SPST_PTS645|F0

|SW306|SW_SPST_PTS645|F1

|SW307|SW_SPST_PTS645|F2

|SW308|SW_SPST_PTS645|F3

|SW309|SW_SPST_PTS645|F4

|SW310|SW_SPST_PTS645|F5

|SW311|SW_SPST_PTS645|SHIFT

|SW312|SW_SPST_PTS645|ESTOP

|SW313|100SP1T1B1M1QEH|DIRECTION

|SW314|SW_SPST_PTS645|F6

|SW315|SW_SPST_PTS645|F7

|SW316|SW_SPST_PTS645|F8

|U401|ESP-12E_SMD|ESP-12E

|X201|Crystal_SMD_TXC_7M-4pin_3.2x2.5mm_HandSoldering|14.7456MHz

|===

The remaining assembly is a basic exercise in installing all the components to the PCB, listed in <<BOM05>>. From assembling the prototypes, the suggested order of installing the components is as follows:

. IC101, IC102, IC201 (note: Rotate PCB so Designator is right side up, then Pin 1 is on top left) and IC301

. X201 and D201

. USB connector CON101

. Capacitors and Resistors in 0805 size (first those on the same side as the items before)

. U401

. Capacitors and Resistors not installed before - that is R403, R404, R405, C401, C402 and C403

. Pushbutton switches SW305 to SW312 and SW314 to SW316 - taking care to place the red one at SW312 and the yellow one at SW311

. Pin headers K401, K402 and P401 (correct alignment of K401 and K402 can be assured by adding a jumper before soldering)

. Pin headers P101 and P201

. Loco selection switches SW301 to SW304

. LEDs D101, D102 and D301 to D303 with 3mm spacers to the PCB - making sure the Anode (long pin) is aligned with the square pad on all of them

. LEDs D304 and D305 - making sure the Anode (long pin) is aligned with the square pad on both, they can be installed on top or bottom of the PCB as desired

. Direction switch SW313 (screwed into the PCB with an 8 mm hex nut first, then attached to it's pads using the cutoffs from D301, D302 and D303) and Speed potentiometer RV301 (screwed into the PCB with a 10 mm hex nut first)

To form a complete BOM, also include the parts listed in <<BOM05extra>> which are not soldered to the PCB but used in assembly later on.

[#BOM05extra]
[cols="1,2,1"]
.List of components for the wiFred up to revision 0.5 excluding electronic parts to solder to PCB
|===
|Designator|Package|Designation

|B1|Battery|Lithium battery 1700mAh

|H1a|Housing black|Strapubox 2090

|or H1b|Housing white|Strapubox 2090

|J1, J2|Jumper|

|K1a|Potentiometer Knob silver|24mm

|or K1b|Potentiometer Knob black|24mm

|P1|PCB|124mm x 35mm x 1.6mm

|S1, S2, S3, S4|Mounting Screws|2,9mm x 6,5mm

|===

After assembling the PCB with all the components, the holes and cutouts in the enclosure most likely will have to be reworked / extended to actually fit the PCB, then the PCB can be screwed into the enclosure with four screws. Afterwards the battery should be connected to P101 making sure the orientation is correct as shown in <<battConnection>> and printed on the PCB, then the battery should be glued to the bottom of the enclosure with double-sided tape so it does not collide with any parts on the PCB, particularly P101 and SW313. Finally, both the ATMega 328P and the ESP8266 will need to be programmed with firmware as described in <<flashing05>>.

[#flashing05]
== Writing the firmware to revision 0.5 and older wiFreds

=== AVR firmware

The ATMega 328P is programmed using the regular AVR ISP connection on P201. Pin 1 - GND - is towards the PCB edge, as shown in <<progAVR>>. An ISP dongle with either automatic voltage selection or 3.3 V supply voltage should be used to avoid placing too high voltage on the ESP8266, which can only support 3.3 V power. The firmware for the ATMega 328P can be found in the *software/avr-firmware*-subdirectory of the <<github>> with both a precompiled hexfile and all source code including a Makefile to recompile as needed. After writing the firmware file and the eeprom file, also the fuse bits need to be set properly as detailed in the *main.c*-file.

[#progAVR]
.Programming connection for ATMega_328P - Pin 1 on purple cable
image::DSC0146.jpg[AVR programming]

=== ESP8266 firmware

The ESP8266 is programmed using the Arduino IDE connected via a serial or USB-to-serial port to the K401 header as shown in <<progESP8266>>. The serial port needs to be at 3.3 V-levels like from an FTDI232-device run at 3.3 V. To program the ESP8266, first the ATMega 328P has to be programmed, a battery has to be connected and reasonably charged and one of the loco selection switches needs to be moved to the "enabled" position to power up the ESP8266.

[#progESP8266]
.Programming connection for ESP8266 - GND on orange wire, then TXD of programming cable (RXD of ESP8266), then RXD of programming cable (TXD of ESP8266) - also note the jumper on P401
image::DSC0138.jpg[ESP8266 programming]

All files in the *software/esp-firmware*-subdirectory of the <<github>> need to be placed in a folder, then the main sketch *arduino_main_sketch.ino.ino* needs to be opened with the Arduino IDE. Settings for the Arduino IDE can be found inside the main file, programming the device should work using the *Upload*-button in the *Sketch*-menu.

To put the ESP8266 into programming mode, a jumper needs to be placed across the P401 header before powering up the ESP8266 by enabling one of the loco selection switches to start the device in programming mode. The red STOP LED should start flashing and the bootloader should show some results on the serial port and during download the LED on the ESP8266 module should flash as well.

After programming, two jumpers need to be placed between the K401 and K402 pin headers to re-enable communication between the ESP8266 and the ATMega 328P as shown in <<serialJumpers>>.

[#serialJumpers]
.Communication jumpers for connecting the ESP8266 and the ATMega 328P
image::DSC0149.jpg[Serial communication jumpers]

[#oldThrottle]
== AA battery first prototype

This wiFred prototype is powered by two AA size battery cells connected to a step-up converter creating 3.3 V for the entire device. As soon as a pair of batteries is inserted into the battery compartment as the symbols inside the battery compartment show, the throttle will boot up and try to connect to a wireless network. The throttle will not be damaged if batteries are inserted wrongly, but it will not work either. Use NiMH- or primary AA cells with 1.2 V to 1.5 V nominal voltage, low self discharge NiMH cells like Eneloop or similar are recommended. 

The schematic is split into several pages and can be found in <<oldSchematicPage1>> to <<oldSchematicPage4>>. It has been created with kicad and is available on the <<github>> along with the PCB design.

[#oldSchematicPage1]
.Master schematic sheet with batteries and power supply
image::old_wfred_rev2.png[alt="Schematic page 1 for AA battery prototype"]

[#oldSchematicPage2]
.Schematic sheet including ESP8266 for WiFi connection with bootloader enabling jumper and connection to programming cable
image::old_wfred-wifi-Wifi_connection.png["Schematic page 2 for AA battery prototype"]

[#oldSchematicPage3]
.Schematic sheet including ATMega 328P along with crystal and in system programming header
image::old_wfred-controller_rev2-Controller.png["Schematic page 3 for AA battery prototype"]

[#oldSchematicPage4]
.Schematic sheet including pushbutton switches, loco selection switches, direction switch and speed potentiometer
image::old_User_interface_rev2-User_Interface.png["Schematic page 4 for AA battery prototype"]

== Hints for building the wiFred AA battery prototype

The prototype PCB has holes in the center of the pushbutton switch footprints and LED footprints to enable transferring their positions to a StrapuBox housing with a sharp needle or similar, and the position of the loco selection switches can also be transferred to the housing by marking it through the non-copper holes at their ends. Refer to <<hintsFor05>> for pictures and more detail, the differences between the AA battery prototype and the LiPo battery revisions are minimal in this aspect.

The remaining assembly is a basic exercise in installing all the components to the PCB, listed in <<oldWiFredBOM>>.

[#oldWiFredBOM]
[cols="1,2,1",options="breakable,autowidth"]
.List of components for the AA battery prototype wiFred
|===
|Designator|Package|Designation

|B101|KEYSTONE1013|BATT_HOLDER

|C206, C205|C_0805_HandSoldering|22p

|C301, C105, C104, C102, C101, C402|C_0805_HandSoldering|22u

|C401, C204, C203, C202, C201, C103|C_0805_HandSoldering|100n

|D301|LED_D3.0mm|STOP - red

|D302|LED_D3.0mm|FORWARD - green

|D303|LED_D3.0mm|REVERSE - green

|IC201|TQFP-32_7x7mm_Pitch0.8mm|ATMEGA328P-A

|K401|Pin_Header_Straight_1x03_Pitch2.54mm|UART_ESP

|K402|Pin_Header_Straight_1x03_Pitch2.54mm|UART_AVR

|L101|L_2424_HandSoldering|22u

|P201|Pin_Header_Straight_2x03_Pitch2.54mm_SMD|ISP

|P401|Pin_Header_Straight_1x02_Pitch2.54mm|ESP_BOOTLOAD

|R301|C_0805_HandSoldering|4k7

|R304, R303, R302|C_0805_HandSoldering|470R

|R401|C_0805_HandSoldering|100k

|R402|C_0805_HandSoldering|47k

|R405, R404, R403, R201|C_0805_HandSoldering|10k

|RV301|P160KNPD|10k lin P160KNPD-4FC20B10K

|SW301|OS102011MS2Q|LOCO1

|SW302|OS102011MS2Q|LOCO2

|SW303|OS102011MS2Q|LOCO3

|SW304|OS102011MS2Q|LOCO4

|SW305|KSC621G|F0

|SW306|KSC621G|F1

|SW307|KSC621G|F2

|SW308|KSC621G|F3

|SW309|KSC621G|F4

|SW310|KSC621G|SHIFT2

|SW311|KSC621G|SHIFT

|SW312|KSC621G|ESTOP

|SW313|100SP1T1B1M1QEH|DIRECTION

|U101|TSSOP-8_4.4x3mm_Pitch0.65mm|L6920D

|U401|ESP-12E_SMD|ESP-12E

|X201|Crystal_SMD_TXC_7M-4pin_3.2x2.5mm_HandSoldering|14.7456MHz

||Housing StrapuBox 6090|

||Two Jumpers, 2.54mm|                                

||Potentiometer Knob, 21 mm|

||Three fastening screws, 2.9 mm dia x 6.5 mm|

|===

After assembling the PCB with all the components and drilling and cutting the holes and cutouts into the housing, there are few steps left. First, a few protrusions inside the housing need to be removed so the PCB fits properly. <<breakProtrusions>> shows how they can be removed easily, remains may be cut off with a hobby knife. Second, new PCB mounting pads need to be installed as shown in <<mountingPads>>. For the prototype, Forex PVC foam was used, cut with a pair of scissors and glued to the housing with superglue, making sure not to be in the way of any components on the PCB, but any kind of easily worked upon material with a thickness of 3 mm can be used, as long as it will take self-driving screws (prototype uses 2.9 mm by 6.5 mm DIN 7981 screws). Third, the two shift keys need yellow paint on the top and the emergency stop key needs red paint - either any kind of paint or a paint marker like Edding 751 will do. Finally, both the ESP8266 and the ATMega 328P will need to be programmed as described in <<flashing05>>.

[#breakProtrusions]
.Removing protrusions inside the housing so the PCB fits
image::DSC8654.jpg[alt="Remove protrusions"]

[#mountingPads]
.New PCB mounting pads made from 3 mm thick Forex PVC
image::DSC8658.jpg[alt="New mounting pads"]

// end::largefile[]

include::biblio_en.adoc[]